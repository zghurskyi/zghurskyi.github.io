<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Oleksii Zghurskyi"><meta name="robots" content="all"><title>Lost Update Phenomena</title><meta name="description" content="An update is lost when a user overrides the current database state without realizing, that someone else changed it between the moment of data loading and the moment the update occurs. In this post, I will give detailed description of this phenomena and..."><meta name="keywords" content="Data Access Layer,Lost Update,Isolation,Pessimistic Locking,Optimistic Locking"><link rel="shortcut icon" type="image/png" href="/favicon.png"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//disqus.com"><link rel="dns-prefetch" href="//c.disquscdn.com"><link rel="canonical" href="https://www.oxymorus.com/lost-update/"><link rel="alternate" type="application/rss+xml" title="Yet Another Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=33"><link rel="stylesheet" href="/css/conum.css?v=33"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700"><meta name="description" content="An update is lost when a user overrides the current database state without realizing, that someone else changed it between the moment of data loading and the moment the update occurs. In this post, I"><meta name="keywords" content="Data Access Layer,Lost Update,Isolation,Pessimistic Locking,Optimistic Locking"><meta property="og:type" content="article"><meta property="og:title" content="Lost Update Phenomena"><meta property="og:url" content="https://www.oxymorus.com/lost-update/index.html"><meta property="og:site_name" content="Yet Another Blog"><meta property="og:description" content="An update is lost when a user overrides the current database state without realizing, that someone else changed it between the moment of data loading and the moment the update occurs. In this post, I"><meta property="og:locale" content="en"><meta property="og:image" content="https://www.oxymorus.com/images/bg-index.jpg"><meta property="og:updated_time" content="2019-10-15T23:19:41.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Lost Update Phenomena"><meta name="twitter:description" content="An update is lost when a user overrides the current database state without realizing, that someone else changed it between the moment of data loading and the moment the update occurs. In this post, I"><meta name="twitter:image" content="https://www.oxymorus.com/images/bg-index.jpg"><meta name="twitter:creator" content="@zghurskyi"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oxymorus.com/lost-update/"},"headline":"Lost Update Phenomena","image":{"@type":"ImageObject","url":"https://www.oxymorus.com/images/bg-index.jpg"},"datePublished":"2019-06-21T23:19:41.000Z","dateModified":"2019-10-15T23:19:41.000Z","author":{"@type":"Person","name":"Oleksii Zghurskyi"},"publisher":{"@type":"Organization","name":"Yet Another Blog","logo":{"@type":"ImageObject","url":"https://www.oxymorus.com/images/site-logo.jpg","height":60,"width":600}},"description":"An update is lost when a user overrides the current database state without realizing, that someone else changed it between the moment of data loading and the moment the update occurs. In this post, I will give detailed description of this phenomena and typical ways to prevent it.","keywords":"Data Access Layer,Lost Update,Isolation,Pessimistic Locking,Optimistic Locking"}</script></head><body class="layout-post"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand"><span>Same difference</span></a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/zghurskyi/zghurskyi.github.io">Github</a></li><li><a href="https://travis-ci.org/zghurskyi/zghurskyi.github.io"><img src="https://travis-ci.org/zghurskyi/zghurskyi.github.io.png?branch=develop"></a></li></ul></div></div></nav><header class="header-section"><div style="background-image:url(/img/post-bg-10.jpg)" class="intro-header"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a href="/categories/data-access-layer/" class="category">Data Access Layer</a><a href="/categories/data-access-layer/lost-update/" class="category">Lost Update</a><a href="/categories/data-access-layer/lost-update/isolation/" class="category">Isolation</a><a href="/categories/data-access-layer/lost-update/isolation/pessimistic-locking/" class="category">Pessimistic Locking</a><a href="/categories/data-access-layer/lost-update/isolation/pessimistic-locking/optimistic-locking/" class="category">Optimistic Locking</a><h1>Lost Update Phenomena</h1><div class="post-meta"><ul><li><time datetime="2019-06-21T23:19:41.000Z" itemprop="datePublished">Jun 21, 2019</time></li><li>2 minutes read</li><li><a href="https://www.oxymorus.com/lost-update/#disqus_thread">0 Comments</a></li></ul></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><div class="paragraph"><p><a href="https://en.wikipedia.org/wiki/Write%E2%80%93write_conflict" target="_blank" rel="noopener">An update is lost</a> when a user overrides the current database state without realizing, that someone else changed it between the moment of data loading and the moment the update occurs. In this post, I will give detailed description of this phenomena and typical ways to prevent it.</p></div><a id="more"></a><div class="sect1"><h2>Lost Update Phenomena</h2><div class="sectionbody"><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/lost_update.png"><img src="/images/lost_update.png" alt="lost update"></a></div></div></div></div><div class="paragraph"><p>There are several approaches to prevent the problem:</p></div><div class="ulist"><ul><li><p>Change isolation level</p></li><li><p>Use pessimistic locking (<code>SELECT &#8230;&#8203; FOR UPDATE</code>)</p></li><li><p>Use optimistic locking (version or timestamp based)</p></li></ul></div></div></div><div class="sect1"><h2>Changing isolation level</h2><div class="sectionbody"><div class="paragraph"><p>Most databases use <code>READ COMMITTED</code> isolation level by default (MySQL - <code>REPEATABLE READ</code>). Choosing isolation level is always a trade-off between consistency and scalability.</p></div><div class="paragraph"><p>If lost update is pretty common scenario in the system, sometime it will make sense to use higher isolation level. For example, either <code>REPEATABLE READ</code> or <code>SERIALIZABLE</code> will prevent lost update from happening.</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/lost_update_isolation_level.png"><img src="/images/lost_update_isolation_level.png" alt="lost update isolation level"></a></div></div></div></div><div class="paragraph"><p>In the situation above, if two transactions try to change the same record, the second will be forced to wait while the first either commits or rollbacks. And if the first transaction commits, the second will be aborted.</p></div><div class="paragraph"><p>The drawback of such approach, is that isolation level is set per database connection, that is not desirable or acceptable in most cases.</p></div></div></div><div class="sect1"><h2>Using pessimistic locking</h2><div class="sectionbody"><div class="paragraph"><p><a href="https://martinfowler.com/eaaCatalog/pessimisticOfflineLock.html" target="_blank" rel="noopener">Pessimistic locking</a> is a common tool used to maintain data consistency.</p></div><div class="paragraph"><p>In relational databases it is usually achieved by using <code>SELECT &#8230;&#8203; FOR UPDATE</code> with default <code>READ COMMITTED</code> isolation level (these combination will lead to acquiring write lock).</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/lost_update_pessimistic_locking.png"><img src="/images/lost_update_pessimistic_locking.png" alt="lost update pessimistic locking"></a></div></div></div></div><div class="paragraph"><p>So, if two transactions try to change the same record, the second will be forced to wait while the first either commits or rollbacks. After first transaction terminates, the second one will see changes and, therefore, no updates will be lost.</p></div><div class="paragraph"><p>It should be mentioned, that <strong>both</strong> transactions should acquire write locks, otherwise lost update won&#8217;t be prevented.</p></div></div></div><div class="sect1"><h2>Using optimistic locking</h2><div class="sectionbody"><div class="paragraph"><p><a href="https://martinfowler.com/eaaCatalog/optimisticOfflineLock.html" target="_blank" rel="noopener">The optimistic locking</a> doesn&#8217;t rely on acquiring write locks. It uses versioning to detect, that data was changed concurrently. If two transactions try to change the same record, the second one won&#8217;t change anything since it will use version, that no longer exist.</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/lost_update_optimistic_locking.png"><img src="/images/lost_update_optimistic_locking.png" alt="lost update optimistic locking"></a></div></div></div></div><div class="paragraph"><p>So, every <code>UPDATE</code> will take version into the <code>WHERE</code> clause. Basically, it optimistically assumes, that no one changing the row concurrently. However, if another transaction commits a newer record version, the second transaction will no longer match any row and therefore the lost update is prevented.</p></div><div class="paragraph"><p>ORMs (e.g. Hibernate) use updated results count to check the number of updated rows. If no row was matched, <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/OptimisticLockException.html" target="_blank" rel="noopener">OptimisticLockException</a> is thrown. After exception is thrown, the current transaction and persistence context are aborted.</p></div></div></div><div class="sect1"><h2>References</h2><div class="sectionbody"><div class="olist arabic"><ol class="arabic"><li><p><a href="https://martinfowler.com/eaaCatalog/pessimisticOfflineLock.html" target="_blank" rel="noopener">Pessimistic offline locking</a></p></li><li><p><a href="https://martinfowler.com/eaaCatalog/optimisticOfflineLock.html" target="_blank" rel="noopener">Optimistic offline locking</a></p></li><li><p><a href="https://vladmihalcea.com/a-beginners-guide-to-database-locking-and-the-lost-update-phenomena/" target="_blank" rel="noopener">A beginners guide to database locking and the lost update phenomena</a></p></li></ol></div></div></div><section class="post-tags"><a href="/tags/data-access-layer/" class="tag post-meta">#Data Access Layer</a><a href="/tags/lost-update/" class="tag post-meta">#Lost Update</a><a href="/tags/isolation/" class="tag post-meta">#Isolation</a><a href="/tags/pessimistic-locking/" class="tag post-meta">#Pessimistic Locking</a><a href="/tags/optimistic-locking/" class="tag post-meta">#Optimistic Locking</a></section><footer class="post-footer"><img src="https://www.gravatar.com/avatar/729584bb1060b4346ad910cf602ffc1c?s=200" class="img-responsive img-circle"><div class="row author"><div class="col-lg-8 col-lg-offset-2 col-xs-10 col-xs-offset-1"><h4>Oleksii Zghurskyi</h4><p></p><ul class="social-links"><li><a href="https://twitter.com/zghurskyi" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/zghurskyi" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2810730/oleksii-zghurskyi?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.linkedin.com/in/oleksii-zghurskyi-96500175/" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li></ul></div></div></footer><section class="related-posts"><h2>You may also like</h2><div class="row"><div class="col-lg-4"><a href="/database-transaction/"><img src="/images/bg-index.jpg" class="img-responsive"><h3>Relational Database Transaction</h3></a><p>Database Transaction represents a unit of work, that is atomic, consistent, isolated and durable (a.k.a. ACID).</p></div><div class="col-lg-4"><a href="/pessimistic-locking-with-reactor-and-aerospike/"><img src="/images/bg-index.jpg" class="img-responsive"><h3>Pessimistic locking with Aerospike and Project Reactor</h3></a><p>How to implement pessimistic locking with Aerospike and Project Reactor ?</p></div><div class="col-lg-4"><a href="/optimistic-locking-with-reactor-and-aerospike/"><img src="/images/bg-index.jpg" class="img-responsive"><h3>Optimistic locking with Aerospike and Project Reactor</h3></a><p>How to implement optimistic locking with Aerospike and Project Reactor ?</p></div></div></section></article><nav role="pagination" class="pagination"><a href="/language-features-java8-to-java11/" class="pull-left btn">← Next post</a><a href="/kafka-provision-spring-boot-starter/" class="pull-right btn">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"></div></div></div><script>var url_parts=window.location.href.split("?"),disqus_url=url_parts[0];!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//oxymorus.disqus.com/embed.js",(document.head||d.body).appendChild(t)}()</script></div></div></div><script id="dsq-count-scr" src="//oxymorus.disqus.com/count.js"></script><footer class="site-footer"><div class="container-fluid"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1"><div class="row"><div class="col-lg-4"><h4>https://www.oxymorus.com/ © 2019</h4><p><em>"Lock it, fill it, curl it, find it, View it, code it, jam, unlock it"</em></p><p><a href="/privacy-policy/">Privacy policy</a></p><p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a></p></div><div class="col-lg-4"><h4 class="marked">Recent articles</h4><section class="recent-posts"><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/camel-masking-sensitive-information/">Apache Camel: Masking sensitive information</a></li><li class="post-list-item"><a class="post-list-link" href="/optimistic-locking-with-reactor-and-aerospike/">Optimistic locking with Aerospike and Project Reactor</a></li><li class="post-list-item"><a class="post-list-link" href="/pessimistic-locking-with-reactor-and-aerospike/">Pessimistic locking with Aerospike and Project Reactor</a></li><li class="post-list-item"><a class="post-list-link" href="/concurrent-sum-of-numbers/">Java concurrency tools</a></li><li class="post-list-item"><a class="post-list-link" href="/observability/">Monitoring Spring Boot service with Prometheus and Grafana</a></li><li class="post-list-item"><a class="post-list-link" href="/language-features-java8-to-java11/">From Java 8 to 11: quick tour</a></li></ul></section></div><div class="col-lg-4"><h4 class="marked">Stay connected</h4><div class="social-links"><ul><li><a href="https://twitter.com/zghurskyi" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/zghurskyi" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2810730/oleksii-zghurskyi?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.linkedin.com/in/oleksii-zghurskyi-96500175/" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li></ul></div><h4 class="marked">Most popular tags</h4><section class="tagcloud"><a href="/tags/acid/" style="font-size:8pt;color:#6a6a6a">ACID</a> <a href="/tags/aerospike/" style="font-size:32pt;color:#bababa">Aerospike</a> <a href="/tags/apache-camel/" style="font-size:8pt;color:#6a6a6a">Apache Camel</a> <a href="/tags/apache-kafka/" style="font-size:8pt;color:#6a6a6a">Apache Kafka</a> <a href="/tags/blocking-processing/" style="font-size:8pt;color:#6a6a6a">Blocking processing</a> <a href="/tags/camelcustomlogmask/" style="font-size:8pt;color:#6a6a6a">CamelCustomLogMask</a> <a href="/tags/data-access-layer/" style="font-size:32pt;color:#bababa">Data Access Layer</a> <a href="/tags/docker/" style="font-size:32pt;color:#bababa">Docker</a> <a href="/tags/github/" style="font-size:8pt;color:#6a6a6a">Github</a> <a href="/tags/isolation/" style="font-size:8pt;color:#6a6a6a">Isolation</a> <a href="/tags/java/" style="font-size:8pt;color:#6a6a6a">Java</a> <a href="/tags/java-9/" style="font-size:8pt;color:#6a6a6a">Java 9</a> <a href="/tags/lost-update/" style="font-size:8pt;color:#6a6a6a">Lost Update</a> <a href="/tags/mysql/" style="font-size:8pt;color:#6a6a6a">MySQL</a> <a href="/tags/non-blocking-processing/" style="font-size:8pt;color:#6a6a6a">Non-blocking processing</a> <a href="/tags/optimistic-locking/" style="font-size:32pt;color:#bababa">Optimistic Locking</a> <a href="/tags/pessimistic-locking/" style="font-size:32pt;color:#bababa">Pessimistic Locking</a> <a href="/tags/project-reactor/" style="font-size:32pt;color:#bababa">Project Reactor</a> <a href="/tags/reactive/" style="font-size:8pt;color:#6a6a6a">Reactive</a> <a href="/tags/spring-boot-starter/" style="font-size:8pt;color:#6a6a6a">Spring Boot Starter</a> <a href="/tags/topic-provisioning/" style="font-size:8pt;color:#6a6a6a">Topic Provisioning</a> <a href="/tags/transaction/" style="font-size:8pt;color:#6a6a6a">Transaction</a> <a href="/tags/back-pressure/" style="font-size:8pt;color:#6a6a6a">back-pressure</a> <a href="/tags/clone/" style="font-size:8pt;color:#6a6a6a">clone</a> <a href="/tags/jq/" style="font-size:8pt;color:#6a6a6a">jq</a></section></div></div></div></div></div><section class="poweredby"><ul class="text-center"><li><span>Published with </span><a href="https://hexo.io" onclick="return window.open(this.href),!1"><img src="/img/logo-hexo.png"></a></li><li><span>Hosted on </span><a href="https://github.com/zghurskyi/zghurskyi.github.io" onclick="return window.open(this.href),!1"><img src="/img/logo-github.png"></a></li><li><span>Deployed with </span><a href="https://travis-ci.org/zghurskyi/zghurskyi.github.io" onclick="return window.open(this.href),!1"><img src="/img/logo-travis.png"></a></li></ul></section></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script id="cookiebanner" src="//cdnjs.cloudflare.com/ajax/libs/cookie-banner/1.2.2/cookiebanner.min.js" data-moreinfo="/privacy-policy/" data-message="This blog uses cookies to enhance your experience. By continuing to visit it you agree to its use of cookies." data-link="#ffad33" data-font-family="Lora,serif" data-font-size="1.6rem" data-bg="#444"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,n,o,t,c,g){a.GoogleAnalyticsObject=t,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(n),g=e.getElementsByTagName(n)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",g.parentNode.insertBefore(c,g)}(window,document,"script",0,"ga"),ga("create","UA-143749857-1","auto"),ga("send","pageview"))</script></body></html>
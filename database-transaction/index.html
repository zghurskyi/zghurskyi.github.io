<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="author" content="Oleksii Zghurskyi"><meta name="robots" content="all"><title>Relational Database Transaction</title><meta name="description" content="Database Transaction represents a unit of work, that is atomic, consistent, isolated and durable (a.k.a. ACID).Database TransactionACID guarantees are provided by traditional relational database management systems (RDBMS).Atomicity means that operation..."><meta name="keywords" content="Data Access Layer,Transaction,ACID"><link rel="shortcut icon" type="image/png" href="/favicon.png"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com"><link rel="dns-prefetch" href="//disqus.com"><link rel="dns-prefetch" href="//c.disquscdn.com"><link rel="canonical" href="https://www.oxymorus.com/database-transaction/"><link rel="alternate" type="application/rss+xml" title="Oxymorus Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/main.css?v=33"><link rel="stylesheet" href="/css/conum.css?v=33"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono:400,700"><meta name="description" content="Database Transaction represents a unit of work, that is atomic, consistent, isolated and durable (a.k.a. ACID)."><meta name="keywords" content="Data Access Layer,Transaction,ACID"><meta property="og:type" content="article"><meta property="og:title" content="Relational Database Transaction"><meta property="og:url" content="https://www.oxymorus.com/database-transaction/index.html"><meta property="og:site_name" content="Oxymorus Blog"><meta property="og:description" content="Database Transaction represents a unit of work, that is atomic, consistent, isolated and durable (a.k.a. ACID)."><meta property="og:locale" content="en"><meta property="og:image" content="https://www.oxymorus.com/images/bg-index.jpg"><meta property="og:updated_time" content="2019-10-16T00:53:41.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Relational Database Transaction"><meta name="twitter:description" content="Database Transaction represents a unit of work, that is atomic, consistent, isolated and durable (a.k.a. ACID)."><meta name="twitter:image" content="https://www.oxymorus.com/images/bg-index.jpg"><meta name="twitter:creator" content="@zghurskyi"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oxymorus.com/database-transaction/"},"headline":"Relational Database Transaction","image":{"@type":"ImageObject","url":"https://www.oxymorus.com/images/bg-index.jpg"},"datePublished":"2019-06-20T00:53:41.000Z","dateModified":"2019-10-16T00:53:41.000Z","author":{"@type":"Person","name":"Oleksii Zghurskyi"},"publisher":{"@type":"Organization","name":"Oxymorus Blog","logo":{"@type":"ImageObject","url":"https://www.oxymorus.com/images/site-logo.jpg","height":60,"width":600}},"description":"Database Transaction represents a unit of work, that is atomic, consistent, isolated and durable (a.k.a. ACID).","keywords":"Data Access Layer,Transaction,ACID"}</script></head><body class="layout-post"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" style="color:#000" class="navbar-brand"><span>Home</span></a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/zghurskyi/zghurskyi.github.io">Github</a></li><li><a href="https://travis-ci.org/zghurskyi/zghurskyi.github.io"><img src="https://travis-ci.org/zghurskyi/zghurskyi.github.io.png?branch=develop"></a></li></ul></div></div></nav><header class="header-section"><div style="background-image:url(/img/post-bg-12.jpg)" class="intro-header"><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><div class="post-heading"><a href="/categories/data-access-layer/" class="category">Data Access Layer</a><a href="/categories/data-access-layer/transaction/" class="category">Transaction</a><a href="/categories/data-access-layer/transaction/acid/" class="category">ACID</a><h1>Relational Database Transaction</h1><div class="post-meta"><ul><li><time datetime="2019-06-20T00:53:41.000Z" itemprop="datePublished">Jun 20, 2019</time></li><li>4 minutes read</li><li><a href="https://www.oxymorus.com/database-transaction/#disqus_thread">0 Comments</a></li></ul></div></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><div class="paragraph"><p>Database Transaction represents a unit of work, that is atomic, consistent, isolated and durable (a.k.a. <code>ACID</code>).</p></div><a id="more"></a><div class="sect1"><h2>Database Transaction</h2><div class="sectionbody"><div class="paragraph"><p><code>ACID</code> guarantees are provided by traditional relational database management systems (RDBMS).</p></div><div class="ulist"><ul><li><p><code>Atomicity</code> means that operations, that constitute transaction are all either succeed or fail together. So, atomicity implies that there can&#8217;t be situation, in which part of operations succeeded and part failed.</p></li><li><p><code>Consistency</code> means that transaction leaves database in consistent state after execution. So, in practical terms, any data written to database must be valid according to integrity constraints (primary key/foreign key/unique key/etc.), cascades, triggers, and any combination thereof.</p></li><li><p><code>Isolation</code> determines how operations performed in a transaction are visible to other executing transactions. So, for example, whether data written by transaction is available for read by other concurrent transactions.</p></li><li><p><code>Durability</code> means that after transaction is committed, database changes are saved permanently. So, if database crushes all committed transactions will be restored. This is most often implemented by using transaction log stored in non-volatile storage. And transaction is committed only after it is entered in the log.</p></li></ul></div></div></div><div class="sect1"><h2>Transaction states</h2><div class="sectionbody"><div class="paragraph"><p>During execution database transaction goes through number of states:</p></div><div class="openblock text-center"><div class="content"><div class="imageblock img-responsive img-thumbnail"><div class="content"><a class="image" href="/images/transaction_state_machine.png"><img src="/images/transaction_state_machine.png" alt="transaction state machine"></a></div></div></div></div><div class="sect2"><h3>State transitions example</h3><div class="paragraph"><p>Assume we have two accounts: one for Alice (account A) and one for Bob (account B). Initially each account has 1000$ balance. The task is to transfer 100$ from account A to account B.</p></div><div class="paragraph"><p>Database transaction for above situation can be represented as follows (in PostgreSQL syntax):</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">BEGIN;

UPDATE accounts SET balance = balance - 100.00
 WHERE name = 'Alice'; <i class="conum" data-value="1"></i><b>(1)</b>

UPDATE accounts SET balance = balance + 100.00
 WHERE name = 'Bob'; <i class="conum" data-value="2"></i><b>(2)</b>

COMMIT;</code></pre></div></div><div class="paragraph"><p>Let&#8217;s follow state transitioning for this transaction:</p></div><div class="olist arabic"><ol class="arabic"><li><p>In <code>ACTIVE</code> state read/write operations on database are performed. So, any statements between <code>BEGIN</code> and <code>COMMIT</code> instructions form <code>ACTIVE</code> state.</p></li><li><p>If transaction reaches <code>COMMIT</code> without failures, then it goes into <code>PARTIALLY COMMITTED</code> state. In <code>PARTIALLY COMMITTED</code> state, balances will have values: A = 900 and B = 1100.</p></li><li><p>If the transaction executes <code>COMMIT</code> successfully, that is, if it successfully writes the new value of A and B into log file or stable storage, then the transaction is said to be in <code>COMMITTED</code> state.</p></li><li><p>Transaction may enter <code>FAILED</code> state:</p><div class="ulist"><ul><li><p>In <code>ACTIVE</code> state:</p><div class="olist loweralpha"><ol class="loweralpha" type="a"><li><p>before first <code>UPDATE</code> ended : then A = 1000 and B = 1000</p></li><li><p>after first <code>UPDATE</code> ended: then A = 900 and B = 1100</p></li><li><p>before <code>COMMIT</code> and after second <code>UPDATE</code>: then A = 900 and B = 1100</p></li></ol></div></li><li><p>In <code>PARTIALLY COMMITTED</code> state: then A = 900 and B = 1100</p></li></ul></div></li><li><p>The transaction enters <code>ABORTED</code> after rollback. In this state DBMS has to undo the changes made so far. So, whatever balances are at the beginning in <code>ABORTED</code> state, after roll back, the state will be reverted to the previous consistent state (A = 1000 and B = 1000)</p></li><li><p>After entering <code>COMMITTED</code> or <code>ABORTED</code> state, transaction is terminated</p></li></ol></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content"><div class="paragraph"><p><em>Why transaction may fail ?</em></p></div><div class="paragraph"><p>Database transaction might fail due to one or more of the following reasons:</p></div><div class="ulist"><ul><li><p>Server failure, e.g. hardware, software or network error, that causes database server to hang or crash</p></li><li><p>Logical transaction failure, e.g. user aborts transaction, division by zero etc.</p></li><li><p>Concurrency failure, e.g. if transaction causes deadlock, or violates serializability</p></li><li><p>Disk failure</p></li></ul></div><div class="paragraph"><p>DBMS usually can recover from server failure, logical failure or concurrency failure. To deal with disk failures - disk backups needs to be maintained.</p></div></td></tr></table></div></div></div></div><div class="sect1"><h2>Savepoints</h2><div class="sectionbody"><div class="paragraph"><p>It&#8217;s possible to control the statements in a transaction in a more granular fashion through the use of <a href="https://www.postgresql.org/docs/8.3/tutorial-transactions.html" target="_blank" rel="noopener">savepoints</a>. Savepoints allow you to selectively discard parts of the transaction, while committing the rest. After defining a savepoint with <code>SAVEPOINT</code>, you can if needed roll back to the savepoint with <code>ROLLBACK TO</code>. All the transaction&#8217;s database changes between defining the savepoint and rolling back to it are discarded, but changes earlier than the savepoint are kept.</p></div><div class="paragraph"><p>After rolling back to a savepoint, it continues to be defined, so you can roll back to it several times. Conversely, if you are sure you won&#8217;t need to roll back to a particular savepoint again, it can be released, so the system can free some resources. Keep in mind that either releasing or rolling back to a savepoint will automatically release all savepoints that were defined after it.</p></div><div class="paragraph"><p>Suppose we debit $100.00 from Alice&#8217;s account, and credit Bob&#8217;s account, only to find later that we should have credited Wally&#8217;s account. We could do it using savepoints like this:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">BEGIN;

UPDATE accounts SET balance = balance - 100.00
 WHERE name = 'Alice';

SAVEPOINT my_savepoint;

UPDATE accounts SET balance = balance + 100.00
 WHERE name = 'Bob';

-- oops ... forget that and use Wally's account
ROLLBACK TO my_savepoint;

UPDATE accounts SET balance = balance + 100.00
 WHERE name = 'Wally';

COMMIT;</code></pre></div></div><div class="paragraph"><p>This example is, of course, oversimplified, but there&#8217;s a lot of control to be had over a transaction block through the use of savepoints.</p></div></div></div><div class="sect1"><h2>Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>Even though this post may seem pretty dry, however, it lays good foundation to get started working with transactions in your Data Access Layer.</p></div><div class="paragraph"><p>In the next posts I will comeback to this topic from more practical perspective in the context of our lovely Spring Boot services. So, stay tuned ;)</p></div></div></div><div class="sect1"><h2>References</h2><div class="sectionbody"><div class="paragraph"><p><a href="https://www.postgresql.org/docs/8.3/tutorial-transactions.html" target="_blank" rel="noopener">PostgreSQL documentation</a></p></div></div></div><section class="post-tags"><a href="/tags/data-access-layer/" class="tag post-meta">#Data Access Layer</a><a href="/tags/transaction/" class="tag post-meta">#Transaction</a><a href="/tags/acid/" class="tag post-meta">#ACID</a></section><footer class="post-footer"><img src="https://www.gravatar.com/avatar/729584bb1060b4346ad910cf602ffc1c?s=200" class="img-responsive img-circle"><div class="row author"><div class="col-lg-8 col-lg-offset-2 col-xs-10 col-xs-offset-1"><h4>Oleksii Zghurskyi</h4><p></p><ul class="social-links"><li><a href="https://twitter.com/zghurskyi" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/zghurskyi" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2810730/oleksii-zghurskyi?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.linkedin.com/in/oleksii-zghurskyi-96500175/" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li></ul></div></div></footer><section class="related-posts"><h2>You may also like</h2><div class="row"><div class="col-lg-4"><a href="/lost-update/"><img src="/images/bg-index.jpg" class="img-responsive"><h3>Lost Update Phenomena</h3></a><p>An update is lost when a user overrides the current database state without realizing, that someone else changed it between the moment of data loading and the moment the update occurs. In this post,...</p></div></div></section></article><nav role="pagination" class="pagination"><a href="/kafka-provision-spring-boot-starter/" class="pull-left btn">← Next post</a><a href="/backpressure/" class="pull-right btn">Previous post →</a></nav><div class="disqus-comments"><div class="comments"><div id="disqus_thread"></div></div></div><script>var url_parts=window.location.href.split("?"),disqus_url=url_parts[0];!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//oxymorus.disqus.com/embed.js",(document.head||d.body).appendChild(t)}()</script></div></div></div><script id="dsq-count-scr" src="//oxymorus.disqus.com/count.js"></script><footer class="site-footer"><div class="container-fluid"><div class="row"><div class="col-lg-10 col-lg-offset-1 col-xs-10 col-xs-offset-1"><div class="row"><div class="col-lg-4"><h4>https://www.oxymorus.com/ © 2020</h4><p><em>"Lock it, fill it, curl it, find it, View it, code it, jam, unlock it"</em></p><p><a href="/privacy-policy/">Privacy policy</a></p><p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a></p></div><div class="col-lg-4"><h4 class="marked">Recent articles</h4><section class="recent-posts"><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/camel-dynamic-routes/">Dynamic Kafka routes with Apache Camel</a></li><li class="post-list-item"><a class="post-list-link" href="/installing-kubernetes/">Installing Kubernetes with microk8s</a></li><li class="post-list-item"><a class="post-list-link" href="/maven-package-to-multiple-java-versions/">Maven: Packaging to multiple Java versions</a></li><li class="post-list-item"><a class="post-list-link" href="/java-repl/">JShell: Awesome Java REPL</a></li><li class="post-list-item"><a class="post-list-link" href="/gatling-load-testing/">Load testing with Gatling</a></li><li class="post-list-item"><a class="post-list-link" href="/decorator/">Different ways to implement Decorator Pattern</a></li></ul></section></div><div class="col-lg-4"><h4 class="marked">Stay connected</h4><div class="social-links"><ul><li><a href="https://twitter.com/zghurskyi" onclick="return window.open(this.href),!1"><span class="fa fa-twitter"></span></a></li><li><a href="https://github.com/zghurskyi" onclick="return window.open(this.href),!1"><span class="fa fa-github"></span></a></li><li><a href="https://stackoverflow.com/users/2810730/oleksii-zghurskyi?tab=profile" onclick="return window.open(this.href),!1"><span class="fa fa-stack-overflow"></span></a></li><li><a href="https://www.linkedin.com/in/oleksii-zghurskyi-96500175/" onclick="return window.open(this.href),!1"><span class="fa fa-linkedin"></span></a></li></ul></div><h4 class="marked">Most popular tags</h4><section class="tagcloud"><a href="/tags/acid/" style="font-size:8pt;color:#6a6a6a">ACID</a> <a href="/tags/aerospike/" style="font-size:16pt;color:#858585">Aerospike</a> <a href="/tags/apache-camel/" style="font-size:16pt;color:#858585">Apache Camel</a> <a href="/tags/apache-kafka/" style="font-size:24pt;color:#9f9f9f">Apache Kafka</a> <a href="/tags/authentication/" style="font-size:8pt;color:#6a6a6a">Authentication</a> <a href="/tags/camelcustomlogmask/" style="font-size:8pt;color:#6a6a6a">CamelCustomLogMask</a> <a href="/tags/data-access-layer/" style="font-size:16pt;color:#858585">Data Access Layer</a> <a href="/tags/docker/" style="font-size:32pt;color:#bababa">Docker</a> <a href="/tags/github/" style="font-size:8pt;color:#6a6a6a">Github</a> <a href="/tags/isolation/" style="font-size:8pt;color:#6a6a6a">Isolation</a> <a href="/tags/java-11/" style="font-size:16pt;color:#858585">Java 11</a> <a href="/tags/java-8/" style="font-size:16pt;color:#858585">Java 8</a> <a href="/tags/kubernetes/" style="font-size:8pt;color:#6a6a6a">Kubernetes</a> <a href="/tags/lost-update/" style="font-size:8pt;color:#6a6a6a">Lost Update</a> <a href="/tags/maven/" style="font-size:16pt;color:#858585">Maven</a> <a href="/tags/mysql/" style="font-size:8pt;color:#6a6a6a">MySQL</a> <a href="/tags/optimistic-locking/" style="font-size:16pt;color:#858585">Optimistic Locking</a> <a href="/tags/password-masking/" style="font-size:8pt;color:#6a6a6a">Password masking</a> <a href="/tags/pessimistic-locking/" style="font-size:16pt;color:#858585">Pessimistic Locking</a> <a href="/tags/project-reactor/" style="font-size:16pt;color:#858585">Project Reactor</a> <a href="/tags/spring-boot/" style="font-size:24pt;color:#9f9f9f">Spring Boot</a> <a href="/tags/transaction/" style="font-size:8pt;color:#6a6a6a">Transaction</a> <a href="/tags/clone/" style="font-size:8pt;color:#6a6a6a">clone</a> <a href="/tags/jq/" style="font-size:8pt;color:#6a6a6a">jq</a> <a href="/tags/microk8s/" style="font-size:8pt;color:#6a6a6a">microk8s</a></section></div></div></div></div></div><section class="poweredby"><ul class="text-center"><li><span>Published with </span><a href="https://hexo.io" onclick="return window.open(this.href),!1"><img src="/img/logo-hexo.png"></a></li><li><span>Hosted on </span><a href="https://github.com/zghurskyi/zghurskyi.github.io" onclick="return window.open(this.href),!1"><img src="/img/logo-github.png"></a></li><li><span>Deployed with </span><a href="https://travis-ci.org/zghurskyi/zghurskyi.github.io" onclick="return window.open(this.href),!1"><img src="/img/logo-travis.png"></a></li></ul></section></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script id="cookiebanner" src="//cdnjs.cloudflare.com/ajax/libs/cookie-banner/1.2.2/cookiebanner.min.js" data-moreinfo="/privacy-policy/" data-message="This blog uses cookies to enhance your experience. By continuing to visit it you agree to its use of cookies." data-link="#ffad33" data-font-family="Lora,serif" data-font-size="1.6rem" data-bg="#444"></script><script src="/js/main.js?v=5"></script><script src="/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad()</script><script>"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(!function(a,e,n,o,t,c,g){a.GoogleAnalyticsObject=t,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=1*new Date,c=e.createElement(n),g=e.getElementsByTagName(n)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",g.parentNode.insertBefore(c,g)}(window,document,"script",0,"ga"),ga("create","UA-143749857-1","auto"),ga("send","pageview"))</script></body></html>
---
layout: post
title:  "Observability: Metrics with Micrometer and Spring Boot"
excerpt: "Practical introduction to mertics with Spring Boot and Micrometer."
modified:   2019-09-11 22:07:41
categories: [Observability, Spring Boot, Prometheus, Grafana, Docker]
comments: true
share: true
aging: true
---
<h1>Observability</h1>
<p>"Observability" is one of buzzwords today. To stay practiacal and concrete, by observability I mean monitoring, tracing and logging.
And to be really "hands-on", in this post I will give recepie of adding Prometheus & Grafana to your pet Spring Boot project.</p>
<p><strong>TL;DR</strong> If you prefer working code vs couple handreds of words - just follow this <a href="https://github.com/zghurskyi/investigations/tree/master/investigation-micrometer">link</a>. It's nothing special, but may be handy.</p>

<h1>What we will build?</h1>
<p>I will follow simple plan:</p>
<ol>
  <li>Setup vanilla Spring Boot application (just stright out-of-the-box starter project)</li>
  <li>Add Prometheus</li>
  <li>Add Grafana</li>
</ol>
<p>So, let's start.</p>

<h1>1. Getting Spring Boot application</h1>
{% highlight yaml %}
$ curl https://start.spring.io/starter.zip \
-d dependencies=actuator,webflux,lombok \
-d type=maven-project \
-d baseDir=monitoring \
-d groupId=com.oxymorus.monitoring \
-d artifactId=monitoring \
-o monitoring.zip
$ unzip monitoring.zip && rm monitoring.zip
{% endhighlight %}

<h1>2. Add Prometheus</h1>
<p>In order to auto-configure Spring Boot support of Promethues, we need to add following dependency to out pom.xml: </p>
{% highlight xml %}		
    <dependency>
			<groupId>io.micrometer</groupId>
			<artifactId>micrometer-registry-prometheus</artifactId>
		</dependency>
{% endhighlight %}
<p>Next we need to setup Promethues with Docker. We will use following script:</p>
{% highlight bash %}
#!/usr/bin/env bash

docker run --net=host \
-p 9090:9090 \
-v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml \
prom/prometheus:v2.2.0
{% endhighlight %}

<p>This script starts Prometheus on port 9090 and configures it to scrape Spring Boot default /actuator/prometheus endpoint.</p>
<p>Full configuration is specified in prometheus.yml:</p>
{% highlight yaml %}
global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
# - "first_rules.yml"
# - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: 'prometheus'
    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.
    static_configs:
      - targets: ['127.0.0.1:9090']

  - job_name: 'spring-actuator'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['127.0.0.1:8080']
{% endhighlight %}

<h1>3. Add Grafana</h1>
    <p>Next, let's start Grafana with following script:</p>
 {% highlight bash %}
#!/usr/bin/env bash

#!/bin/sh
docker run -i --net=host \
-p 3000:3000 \
-v $(pwd)/grafana-datasource.yml:/etc/grafana/provisioning/datasources/grafana-datasource.yml \
-v $(pwd)/dashboards/grafana-dashboard.yml:/etc/grafana/provisioning/dashboards/grafana-dashboard.yml \
-v $(pwd)/dashboards/jvmgc-dashboard.json:/etc/grafana/dashboards/jvmgc.json \
-v $(pwd)/dashboards/latency-dashboard.json:/etc/grafana/dashboards/latency.json \
-v $(pwd)/dashboards/processor-dashboard.json:/etc/grafana/dashboards/processor.json \
grafana/grafana:5.1.0
{% endhighlight %}

<p>As you can see, we specify couple of dashboards, that will allow to monitory some app metrics.</p>
<p>The important config, that connects Grafana with Prometheus as its datasource is in grafana-datasource.yml file:</p>

{% highlight yaml %}
apiVersion: 1

datasources:
  - name: prometheus
    type: prometheus
    access: direct
    url: http://127.0.0.1:9090
{% endhighlight %}

    <h1>Checking everything</h1>
    <p>To check everything works properly let's start it together:</p>
{% highlight yaml %}
$ mvn spring-boot:run
$ ./prometheus.sh
$ ./grafana.sh
{% endhighlight %}
<p>After app is running and metrics are collected, we can perform some load testing and observe how app behaves:</p>
{% highlight yaml %}
$ ab -n 120000 -c 2 http://localhost:8080/actuator/prometheus
{% endhighlight %}

